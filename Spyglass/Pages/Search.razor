@page "/search"

@using Microsoft.IdentityModel.Tokens
@using Models
@using Services
@using System.Text
@using System.Text.Json

@inject AppSettings AppSettings
@inject HttpClient Http

<PageTitle Title="Search Magnifier" />

<div class="px-4">
    <Heading size="2">Search comments</Heading>
    <EditForm Model="@query" OnValidSubmit="@SearchComments">
        <Heading size="3">Query</Heading>
        <InputText @bind-Value="@query.query" placeholder="JSON search query" class="transition duration-300 bg-white hover:bg-whiteHover active:outline-none focus:outline-none text-black font-dosis text-4xl rounded-2xl p-3"></InputText>
        <Button primary>View comments</Button>
        @if (error)
        {
        <Heading size="3"><span class="text-red">Invalid search query!</span></Heading>
        }
        <Heading size="3">@progress</Heading>
    </EditForm>
</div>

@code {
    private SearchQuery query = new SearchQuery();

    private bool error;

    private string progress;

    private async Task SearchComments()
    {
        HttpResponseMessage response = await Http.SendAsync(new HttpRequestMessage(HttpMethod.Get, AppSettings.ApiRoot + $"/Comments/query?query={Base64UrlEncoder.Encode(Encoding.UTF8.GetBytes(query.query))}"));

        if (!response.IsSuccessStatusCode || query.query == "")
        {
            error = true;
            progress = "";
        }
        else
        {
            List<Comment> comments = await response.Content.ReadFromJsonAsync<List<Comment>>();

            progress = "Loading...";
        }
    }
}